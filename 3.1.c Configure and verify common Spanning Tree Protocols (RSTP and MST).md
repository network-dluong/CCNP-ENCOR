## Spanning Tree Protocol (STP) 802.1D  
* Enables switches to become aware of other switches through the advertisement and receipt of bridge protocol data units (BPDUs)  
* Builds Layer 2 loop-free topology by blocking traffic on redundant ports  

* **802.1D Port States**:  
  * **Disabled** - shut down  
  * **Blocking** - switch port is enabled but not forwarding any traffic to ensure no loops, and does not modify the MAC address table  
  * **Listening** - switch port transitioned from blocking state and now sends or receives BPDUs, but cannot forward any other network traffic  
  * **Learning** - switch port modifies MAC address table with any network traffic it receives, but does not forward any other network traffic besides BPDUs  
  * **Forwarding** - switch port can forward all network traffic and updates MAC address table  
  * **Broken** - switch has detected a configuration or operation problem on a port, and port discards packets as problem exists  
  
* **802.1D Port Types**:  
  * **Root port (RP)** - network port that connects to the root bridge or an upstream switch (only one RP per VLAN)  
  * **Designated port (DP)** - network port that receives and forwards BPDU frames to other switches, and provides connectivity to downstream devices and switches (only one active DP on a link)  
  * **Blocking port** - network port that is not forwarding traffic because of STP calculations  
  
* **STP Terminology**:  
  * **Root bridge** - all ports in forwarding state and are DPs  
  * **Bridge protocol data unit (BPDU)** - network packets used for network switches to identify a hierarchy and notify changes in topology (destination MAC address 01:80:c2:00:00:00)  
    * Configuration BPDU - used to identify root bridge, RPs, DPs, and blocking ports  
    * Topology change notification (TCN) BPDU - used to communicate changes in Layer 2 topology to other switches  
  * **Root path cost** - combined cost for a specific path toward root switch  
  * **System priority** - 4-bit value that indicates preference for a switch to be root bridge (default value of 32,768)  
  * **System ID extension** - 12-bit value that indicates VLAN that the BPDU correlates to. System priority + system ID extension (VLAN ID) = part of switch's identification of root bridge  
  * **Root bridge identifier** - combination of root bridge system MAC address, system ID extension (VLAN ID), and system priority of root bridge  
  * **Local bridge identifier** - combination of local switch's bridge system MAC address, system ID extension (VLAN ID), and system priority of root bridge  
  * **Max age** - maximum length of time that passes before a bridge port saves its BPDU information (dfeault value is 20 seconds but can be changed)  
  > **spanning-tree vlan (*vlan-id*) max-age (*maxage*)**  
  * **Hello time** - time that a BPDU is advertised out of port (default value is 2 seconds but can be changed from 1 to 10)  
  > **spanning-tree vlan (*vlan-id*) hello-time (*1-10*)**  
  * **Forward delay** - amount of time that port stays in listening and learning state (default value is 15 seconds but can be changed from 15 to 30)  
  > **spanning-tree vlan (*vlan-id*) forward-time (*15-30*)**  
  
* **STP Path Cost**:   
  * **Short mode** - 16-bit value with reference value of 20 Gbps (default)  
  * **Long mode** - 32-bit value with reference value of 20 Tbps  
  > **spanning-tree pathcost method long**  
  
  | **Link Speed** | **Short-Mode STP Cost** | **Long-Mode STP Cost** |
  | --- | --- | --- |
  | 10 Mbps | 100 | 2.000.000 |
  | 100 Mbps | 19 | 200,000 |
  | 1 Gbps | 4 | 20,000 |
  | 10 Gbps | 2 | 2,000 |
  | 20 Gbps | 1 | 1,000 |
  | 100 Gbps | 1 | 200 |
  | 1 Tbps | 1 | 20 |
  | 10 Tbps | 1 | 2 |
  
  
* **Root Bridge Election**:  
  * If neighbor's configuration BPDU is inferior, the switch ignores that BPDU  
  * If neighbor's configuration BPDU is preferred, the switch updates its BPDUs to include the new root bridge identifier with a new root path cost that correlates to the total path cost to reach the new root bridge  
  * STP deems a switch more preferable if priority in the bridge identifier is lower than other switch's  
  * If priority is the same, then switch prefers BPDU with lower system MAC address  
 > **show spanning-tree root**  


* **Locating Root Ports**:  
  * The Root Port (RP) is selected through the following steps (the next step is used in the event of a tie):  
1. The interface associated to lowest path cost is more preferred  
2. The interface associated to the lowest system priority of the advertising switch is preferred  
3. The interface associated to the lowest system MAC address of the advertising switch is preferred  
4. When multiple links are associated to the same switch, the lowest port priority from the advertising switch is preferred  
5. When multiple links are associated to the same switch, the lower port number from the advertising switch is preferred  


* **Locating Blocked Designated Switch Ports**:  
  * To prevent forwarding loop, the following steps will calculate which ports should be blocked between two non-root switches:  
1. The interface is a DP and must not be considered an RP  
2. The switch with lower path cost to root bridge forwards packets, and the one with the higher path cost blocks packets. In case of a tie, go to next step  
3. The system priority of the local switch is compared to the system priority of remote switch. Local port is moved to blocking state if remote system priority is lower than that of local switch. In case of a tie, go to next step  
4. The system MAC address of local switch is compared to system priority of remote switch. Local designated port is moved to blocking state if remote system MAC address is lower than that of local switch  
  * To locate a port's STP state:  
 > **show spanning-tree** **[vlan (*vlan id*)]**  
 > **show spanning-tree inteface (*int-id*)** **[detail]**  
 > **show spanning-tree** **[vlan (*vlan-id*)]** **detail**  


## Rapid Spanning Tree Protocol (RSPT) 802.1W
* **Port States**:  
  * **Discarding** - switch port is enabled, but port is not forwarding any traffic to prevent loops (combines Disabled, Blocking, and Listening)  
  * **Learning** - switch port modifies MAC address table with any network traffic it receives, but does not forward any other network traffic besides BPDUs  
  * **Forwarding** - switch port forwards all network traffic and updates MAC address table  
  
* **Port Roles**:  
  * **Root Port (RP)** - network port that connects to root switch or upstream switch (only one RP per VLAN)  
  * **Designated Port (DP)** - network port that receives and forwards frames to other switches, and provides connectivity to downstream devices and switches (only one active DP on a link)  
  * **Alternate port** - network port that provides alternate connectivity toward root switch through a different switch  
  * **Backup port** - network port that provides link redundancy toward current root switch (only exists when multiple links connect between the same switches). It cannot guarantee connectivity to root bridge if upstream switch fails  

* **Port Types**:  
  * **Edge port** - port at the edge of the network where hosts connect to Layer 2 topology with one interface and cannot form a loop (correlates to ports that have STP portfast enabled)  
  * **Root port** - port that has best path cost toward root bridge (only one RP per switch)  
  * **Point-to-point port** - any port that connects to another RSTP switch with full duplex (full duplex links do not permit more than two devices on a network segment)  

* **RSTP Topology**:  
1. When first two switches connect to each other, they verify that they are connected with point-to-point link by checking the full-duplex status  
2. They establish a handshake with each other to advertise a proposal that their interface should be the DP for that port  
3. There is only one DP per segment, and each switch identifies itself as superior or inferior  
4. The inferior switch marks its local port as the RP. It moves all no-edge ports to discarding state (switch has stopped all local switching for non-edge ports)  
5. The inferior switch sends an agreement to the root bridge, which signifies that synchronization is occurring on that switch  
6. The inferior and superior switch move their RP to forwarding state  
7. The inferior switch repeats the process for any downstream switches connected to it  


## STP Topology Tuning  
* **Root Bridge Placement**:  
  * Ideally the root bridge is placed on a core switch, and a secondary root bridge is designated to minimize changes to overall STP  
  * Accomplished by lowering system priority on the root bridge to lowest value possible, raising secondary root bridge to a value slightly higher than root bridge, and increasing system priority on all other switches
  * Priority is set with either of these two commands:  
  > **spanning-tree vlan (*vlan-id*) priority (*0 - 61,440*)**  
  > **spanning-tree vlan (*vlan-id*) root {primary | secondary}** **[diameter (*diameter*)]**  
  * **Priority** is in increments of 4,096; **Primary** is 24,576; **Secondary** is 28,672  
  * (Optional) **diameter** - tunes STP convergence and modifies the timers  
  * Best way to prevent devices from taking over STP root role is to set the primary root switch with a priority of 0 and seoncdary root switch with a priority of 4,096  
  
* You can lower a path that is currently an alternate port to make it designated port, or raise the cost of a designated port and turn it into a blocking port  
* To modify the STP forwarding path:  
> **spanning-tree** **[vlan (*vlan-id*)]** **cost (*cost*)**  
* To modify the port priority:  
> **spanning-tree** **[vlan (*vlan-id*)]** **port-priority (*priority*)**  


## STP Protection Mechanisms  
* Some **common scenarios** for Layer 2 forwarding loops:  
  * STP is disabled on a switch  
  * A misconfigured load balancer that transmits traffic out multiple ports with the same MAC address  
  * A misconfigured virtual switch that bridges two physical ports (virtual switches typically do not partake in STP)  
  * End users using a dumb switch or hub  

* **Root Guard**:  
  * Enabled on a port-by-port basis - prevents a configured port from becoming a root port  
  * Prevents a downstream switch (misconfigured or rogue) from becoming a root bridge  
  * Places port in an ErrDisabled state if a superior BPDU is received on a configured port  
  * Root Guard is placed on DPs toward other switches that should never become root bridges  
  > **spanning-tree guard root**  
  
* **STP Portfast**:  
  * Disables TCN generation for access ports  
  * For Portfast, the access ports bypass the earlier 802.1D STP states (learning and listening) and forwards traffic immediately  
  * Beneficial in environments where computers use DHCP or PXE  
  > **spanning-tree portfast default**  
  > **spanning-tree portfast disable**  
  * Portfast can be enabled on trunk links, but should only be used with ports that are connecting to a single host:  
  > **spanning-tree portfast trunk**  
  
* **BPDU Guard**:  
  * Safety mechanism that shuts down ports configured with STP portfast upon receipt of a BPDU
  * Ensures that a loop cannot accidentally be created if an unauthorized switch is added to the topology  
  * To enable globally on all STP portfast ports:  
  > **spanning-tree portfast bpduguard default**  
  * To enable/disable on a specific interface:  
  > **spanning-tree bpduguard {enable | disable}**  
  > **show interfaces status**  
  * By default, ports that are in ErrDisabled state do not automatically restore themselves  
  * To enable Error Recovery service and modify the period it checks for ports:  
  > **errdisable recovery cause bpduguard**  
  > **errdisable recovery interval (*time-seconds*)**  
  
* **BPDU Filter**:  
  * Blocks BPDUs from being transmitted out a port. For globally enabled:  
  > **spanning-tree portfast bpdufilter default**  
  * Port sends a series of 10 to 12 BPDUs. If switch receives any BPDUs, it checks to identify which switch is more preferred  
    * Preferred switch does not process any BPDUs that it receives, but still transmits to inferior downstream switches  
    * Switch that is not the preferred switch will process BPDUs that are received, but does not transmit BPDUs to superior upstream switch  
  * For interface-specific:  
  > **spanning-tree bpdufilter enable**  
  * Most network designs do not require BPDU filter  
  
* **STP Loop Guard**:  
  * Prevents any alternative or RPs from becoming DPs (ports toward downstream switches) due to loss of BPDUs on the RP  
  * Places the original port in an ErrDisabled state whil BPDUs are not being received  
  * Can be enabled globally, or interface specific:  
  > **spanning-tree loopguard default**  
  > **spanning-tree guard loop**  
  * Loop guard should not be enabled on portfast enabled ports because it directly conflicts with the root/alternate port logic  
  * To view inconsistent ports:  
  > **show spanning-tree inconsistentports**  

* **Unidirectional Link Detection (UDLD)**:  
  * Allows for the bidirectional monitoring of fiber-optic cables  
  * Transmits UDLD packets to neighbor device which includes system ID and port ID of the interface  
  * Receiving device repeats this information back to the originating device  
    * **Normal** - if a frame is not acknowledged, the link is considered underdetermined and the port remains active  
    * **Aggressive** - When a fram is not acknowledged, the switch sends another eight packets in 1-second intervals. If those packets are not acknowledged, the port is placed into an error state  
  * To enable UDLD on any small form-factor pluggable (SFP) based port, or port-by-port basis, and to disable on a specific port and recovery:  
  > **udld enable [aggressive]**  
  > **udld port [aggressive]**  
  > **udld port disable**  
  > **udld recovery [interval (*time*)]**  
  * UDLD must be enabled on the remote switch as well. To verify neighborship, and view more detailed information:  
  > **show udld neighbors**  
  > **show udld (*int-id*)**  
  
  
## Multiple Spanning Tree Protocol (MSTP)  802.1S  
* **MST instance (MSTI)** - provides a blended approach by mapping one or more VLANs onto a single STP tree  
* **MST region** - grouping of MST switches with the same high-level configuration  
  * **Internal Spanning Tree (IST)** - the first instance (instance 0) which the MST uses as a special STP instance  
  * IST runs on all switch port interfaces in the MST region, regardless of the VLANs associated with the ports  
  * Cisco supports up to 16 MST instances by default  
  * IST is always instance 0, and 1 - 15 can support other VLANs and is known as MSTIs  

* **MST Configuration**:  
1. Define MST as the STP:  
> **spanning-tree mode mst**  
2. (Optional) Define the MST instance priority wth one of two methods:  
> **spanning-tree mst (*instance-number*) priority (*0 - 61,440*)**  
> **spanning-tree mst (*instance-number*) root {primary | secondary} [diameter (*diameter*)]**  
   * Priority is in increments of 4096; **primary** is set to 24,576; **secondary** is set to 28,672  
3. Associate VLANs to an MST instance. All VLANs are associated to MST 0 instance by default. The MST configuration must be configured, then the VLANs are assigned to a different MST instance:  
> **spanning-tree mst configuration**  
> **instance (*instance-number*) vlan (*vlan-id*)**  
4. Specify the mst version number. It must match for all switches in the same MST region:
> **revision (*version*)**  
5. (Optional) Define the MST region name. MST regions are recognized by switched that share a common name. A region name is an empty string by default:  
> **name (*mst-region-name*)**  
* To get a consolidated view of the MST topology table, or for a specific interface:  
> **show spanning-tree mst [(*instance-number*)]**  
> **show spanning-tree mst interface (*int-id*)**  

* **MST Tuning**:  
  * MST supports the tuning of port cost and port priority  
  > **spanning-tree mst (*instance-number*) cost (*cost*)**  
  > **spanning-tree mst (*instance-number*) port-priority (*priority*)**  

* **Common MST Misconfigurations:**  
  * VLAN Assignment to the IST:  
    * IST topology may not correlate to the access layer and might introduce a blocking port that was not intentional  
    * To fix - move VLAN to an MSTI instance other than the IST. The switches will build a topology based on the links in use by that MSTI  
    * Another fix - allow the VLANs associated with the IST on all interswitch (trunk) links  
  * Trunk Link Pruning:  
    * Pruning of VLANs does not occur for VLANs in the same MST on different network links  
    * To fix - only prune all the VLANs in the same MSTI for a trunk link  
    
* **MST Region Boundary**:  
  * Any port that connects to a switch that is in a different MST region or that connects to 802.1D or 802.1W BPDUs  
  * PVST simulation mechanism - propagates the CST at the MST region boundary  
    * Sends out PVST+ (and RSTP) BPDUs (one for each VLAN) using the information from the IST  
    * PVST+/RSTP topologies do not understand the IST BPDU structure  
    * MST boundary maps the PVST+ BPDU from VLAN 1 to the IST instance  
    * Two designs - MST region is the root bridge, or MST region is not the root bridge  
  * MST Region as the Root Bridge:
    * Ensures that all region boundary ports flood the same IST instance BPDU to all the VLANs in the PVST topology  
    * MST region appears as a single entity, and the PVST+ switches detect the alternate link and place it into a blocking state  
  * MST Region Not as a Root Bridge for Any VLAN:  
    * MST region boundary ports can only block or forward for all VLANs  
    * PVST simulation check - if an MST switch detects a better BPDU for a specific VLAN on a boundary port, the switch will use BPDU guard to block this port. Port will be placed into a root inconsistent state  
    
    
   > *[Back](https://github.com/network-dluong/CCNP-ENCOR/tree/3.0-Infrastructure)*   
    

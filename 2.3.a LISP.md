### LISP (Locator/ID Separation Protocol)  
* routing architecture and a data and control plane protocol used to correct aggregation issues, traffic engineering, multihoming, and routing instability  
  * Endpoint identifier (EID) - IP address of an endpoint within a LISP site  
  * LISP site – name of a site where LISP routers and EIDs reside  
  * Ingress tunnel router (ITR) - LISP-encapsulate IP packets coming from EIDs that are destined outside the LISP site  
  * Egress tunnel router (ETR) - de-encapsulate LISP-encapsulated IP packets coming from sites outside the LISP site and destined to EIDs within the LISP site  
  * Tunnel router (xTR) - perform ITR and ETR functions  
  * Proxy ITR (PITR) - acts like ITRs but for non-LISP sites that send traffic to EID destinations  
  * Proxy ETR (PETR) - acts like ETRs but for EIDs that send traffic to destinations at non-LISP sites  
  * Proxy xTR (PxTR) - performs PITR and PETR functions  
  * LISP router – performs functions of any or all of the following: ITR, ETR, PITR, and/or PETR  
  * Routing locator (RLOC) - IPv4 or IPv6 address of an ETR that is Internet facing or network core facing  
  * Map server (MS) - network device that learns EID-to-prefix mapping entries from an ETR and stores them in a local EID-to-RLOC mapping database  
  * Map resolver (MR) - network devices that receives LISP-encapsulated map requests from an ITR and finds appropriate ETR to answer those requests by consulting the MS  
      * Map server/map resolver (MS/MR) - MS and MR functions implemented on same device  


* LISP Routing Architecture – separates IP address into EIDs and RLOCs. Endpoints can roam from site to site, and only the RLOC changes while EID remains the same  
* LIS Control Plane – like DNS, LISP can resolve an EID into an RLOC by sending map request to the MR. Based on pull model, where only the routing information that is necessary is requested  
* LISP Data Plane – ITRs LISP-encapsulate IP packets received from EIDs in outer IP UDP header with source and destination addresses in RLOC space (IP-in-IP/UDP encapsulation). Original IP header and data are preserved (inner header). LISP shim header is included to encode information necessary to enable forwarding plane functionality  
  * Outer LISP IP header – added by an ITR to encapsulate EID IP addresses  
  * Outer LISP UDP header – contains source port selected by ITR to prevent traffic from one LISP site to another, from it taking the same path even if there are equal-cost multipath links (ECMP) to destination. Improves load sharing by preventing polarization. UDP port 4341  
  * Instance ID – 24-bit value used to provide device and path-level network virtualization. Enables VRF and VPNs for virtualization and segmentation. Prevents IP address duplication within LISP site  
  * Original IP header – IP header received by an EID  
  * IPv4 RLOCS encapsulating IPv4/IPv6 EIDs; IPv6 RLOCS encapsulating IPv4/IPv6 EIDs  


### LISP Operation  
* Map Registration and Notification  
  * ETR sends map register message to MS to register associated EID prefix. Message includes RLOC IP address  
  * MS sends map notify message to ETR to confirm that map register has been received and processed, uses UDP port 4342  


* Map Request and Reply  
  * Endpoint in LISP Site 1 (host 1) sends DNS request to resolve IP address of endpoint in LISP site 2 (host 2). DNS replies with IP address (destination EID). If host1 not directly connected to ITR, IP packets will forward through LISP site as normal IP packets using traditional routing  
  * ITR receives packets from host1 and performs FIB lookup:  
  * Does packet match default route because no route found in routing table? Yes = continue; No = forward packet natively using matched route  
    * Is source IP a registered EID prefix in local map cache? Yes = continue; No = forward packet natively  
    * ITR sends encapsulated map request to MR, uses UDP port 4342  
    * MS mapping database system forwards map request to authoritative ETR. If MR and MS functions on different devices, MR forwards encapsulated map request packet to the MS as received from ITR, and MS forwards map request packet to ETR  
    * ETR sends ITR a map reply message that includes EID-to-RLOC mapping  
    * ITR install EID-to-RLOC mapping in local map cache and programs FIB  


* LISP Data Patch  
  * ITR receives packet from EID host1 destined to host2  
  * ITR performs FIB lookup and finds match. It encapsulates EID packet and adds outer header with RLOC IP address from ITR as source IP, and RLOC IP address of ETR as destination IP. Forwarded using UDP port 4341  
  * ETR receives encapsulated packet and de-encapsulates it to forward to host2  


* Proxy ETR (PETR)  
  * Host1 performs DNS lookup for cisco.com, gets response from DNS server and starts forwarding packets to ITR  
  * ITR sends map request to MR  
  * Mapping database system responds with negative map reply that includes calculated non-LISP prefix for ITR to add to mapping cache and FIB  
  * ITR now sends LISP-encapsulated packets to PETR  
  * PETR de-encapsulates traffic and sends to cisco.com  


* Proxy ITR (PITR)  
  * Traffic from cisco.com received by PITR with destination IP from host1  
  * PITR sends map request to MR  
  * Mapping database system forwards map request to ETR  
  * ETR sends map reply to PITR with EID-to-RLOC mapping  
  * PITR LISP encapsulates packets and forwards to ETR  
  * ETR receives LISP-encapsulated packets, de-encapsulates and sends to host1  
  
  
  > [*Back*](https://github.com/network-dluong/CCNP-ENCOR/tree/2.0-Virtualization)
